<html>

<head>
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
  <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
    href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" />

  <title>Galileo Design</title>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="../js/chat-dot.js"></script>
  <script src="../js/notifications-common.js"></script>

</head>

<body>
  <div class="relative flex size-full min-h-screen flex-col bg-[#fcfaf8] dark group/design-root overflow-x-hidden"
    style="font-family: Inter, 'Noto Sans', sans-serif">
    <div class="layout-container flex h-full grow flex-col">
      <header
        class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#f3eee7] px-10 py-3">
        <div class="flex items-center gap-8">
          <div class="flex items-center gap-4 text-[#1b150d]">
            <div class="size-4">
              <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd"
                  d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z"
                  fill="currentColor"></path>
              </svg>
            </div>
            <h2 class="text-[#1b150d] text-lg font-bold leading-tight tracking-[-0.015em]">
              Craftsman
            </h2>
          </div>
          <div class="flex items-center gap-9">
            <a class="text-[#1b150d] text-sm font-medium leading-normal" href="dashboard.html">Dashboard</a>
            <a class="text-[#1b150d] text-sm font-medium leading-normal" href="job.html">Hire</a>
            <a class="text-[#1b150d] text-sm font-medium leading-normal" href="Apply.html">Apply</a>
            <a class="text-[#1b150d] text-sm font-medium leading-normal" href="myjob.html">My Jobs</a>
            <a class="text-[#1b150d] text-sm font-medium leading-normal" href="proposal.html"
              id="proposals-link">Proposals</a>
          </div>
        </div>
        <div class="flex flex-1 justify-end gap-8">
          <div class="flex gap-2">
            <a href="Notification.html" class="relative">
              <button
                class="relative flex items-center justify-center h-10 w-10 rounded-xl bg-[#f3eee7] text-[#1b150d]">
                <!-- Red Dot for Unread -->
                <span id="notif-dot"
                  class="absolute -top-0.5 -right-0.5 h-2 w-2 bg-red-500 rounded-full ring-2 ring-white hidden"></span>

                <!-- Bell Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor"
                  viewBox="0 0 256 256">
                  <path
                    d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z">
                  </path>
                </svg>
              </button>

            </a>
            <a href="chat.html" class="relative">
              <button
                class="relative h-10 w-10 rounded-xl bg-[#f3eee7] text-[#1b150d] flex items-center justify-center">
                <span id="chat-dot"
                  class="absolute -top-0.5 -right-0.5 h-2 w-2 bg-red-500 rounded-full ring-2 ring-white hidden"></span>

                <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor"
                  viewBox="0 0 256 256">
                  <path
                    d="M140,128a12,12,0,1,1-12-12A12,12,0,0,1,140,128ZM84,116a12,12,0,1,0,12,12A12,12,0,0,0,84,116Zm88,0a12,12,0,1,0,12,12A12,12,0,0,0,172,116Zm60,12A104,104,0,0,1,79.12,219.82L45.07,231.17a16,16,0,0,1-20.24-20.24l11.35-34.05A104,104,0,1,1,232,128Zm-16,0A88,88,0,1,0,51.81,172.06a8,8,0,0,1,.66,6.54L40,216,77.4,203.53a7.85,7.85,0,0,1,2.53-.42,8,8,0,0,1,4,1.08A88,88,0,0,0,216,128Z">
                  </path>
                </svg>
              </button>
            </a>

            <a href="Setting.html" class="bg-[#f3eee7] rounded-xl h-10 flex items-center px-2.5">
              ⚙️
            </a>
          </div>
          <a href="#" id="profile-link">
            <div id="profile-pic" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10"></div>
          </a>
        </div>
      </header>
      <div class="gap-1 px-6 flex flex-1 justify-center py-5">
        <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
          <div class="flex flex-wrap justify-between gap-3 p-4">
            <div class="flex min-w-72 flex-col gap-3">
              <p class="text-[#111922] tracking-light text-[32px] font-bold leading-tight">
                Your Jobs
              </p>
              <p class="text-[#93adc8] text-sm font-normal leading-normal">
                Manage your projects
              </p>
            </div>
          </div>
          <div id="posted-jobs-list"></div>
          <div id="pending-rating-section" class="mt-6 space-y-4 hidden">
            <h3 class="text-lg font-bold text-[#1b150d]">Pending Ratings</h3>
            <div id="pending-rating-jobs" class="space-y-2"></div>
          </div>



          <script>
            document.addEventListener("DOMContentLoaded", async () => {
              let craftsmanId = new URLSearchParams(window.location.search).get(
                "craftsmanId"
              );

              if (!craftsmanId) {
                craftsmanId = localStorage.getItem("craftsmanId");
                if (!craftsmanId) {
                  Swal.fire({
                    icon: "warning",
                    title: "Login Required",
                    text: "You must be logged in to view your jobs.",
                    confirmButtonColor: "#facc15",
                    background: "#fef9c3",
                    backdrop: "rgba(253,224,71,0.3)",
                  });
                  return;
                }
              }

              localStorage.setItem("craftsmanId", craftsmanId);
              await fetchPostedJobs(craftsmanId);
              await fetchUnratedCompletedJobs(craftsmanId);

              try {
                const res = await fetch(`/api/profile/${craftsmanId}`);

                if (!res.ok)
                  throw new Error(
                    `Failed to fetch profile: ${response.status} ${response.statusText}`
                  );

                const data = await res.json();

                console.log("✅ API Response:", data); // Debugging log

                if (!data || !data.profileImage) {
                  console.error("❌ Profile image is missing in API response");
                  return;
                }

                const profileImage = data.profileImage.trim()
                  ? data.profileImage
                  : "/uploads/default.png";
                console.log("✅ Profile Image URL:", profileImage);

                const profilePicDiv = document.getElementById("profile-pic");
                if (profilePicDiv) {
                  profilePicDiv.style.backgroundImage = `url(${profileImage})`;
                } else {
                  console.error("❌ profile-pic element not found");
                }

                document.getElementById(
                  "profile-pic"
                ).style.backgroundImage = `url(${profileImage})`;

                const mainSkill =
                  data.skills && data.skills.length > 0
                    ? data.skills[0].name
                    : "General";
                const profileLink = document.getElementById("profile-link");

                if (profileLink) {
                  profileLink.href = `Profile2.html?craftsmanId=${craftsmanId}&skill=${encodeURIComponent(
                    mainSkill
                  )}`;
                } else {
                  console.error("❌ profile-link element not found");
                }
              } catch (error) {
                console.error("❌ Error loading profile:", error);
                Swal.fire({
                  icon: "error",
                  title: "Profile Load Failed",
                  text: "Unable to load your profile. Please refresh or try again.",
                  confirmButtonColor: "#ef4444",
                  background: "#fef2f2",
                  backdrop: "rgba(239, 68, 68, 0.2)",
                });
              }
            });

            //fetching
            async function fetchPostedJobs(userId) {
              try {
                const res = await fetch(`/api/jobs/posted/${userId}`);
                if (!res.ok) throw new Error("Failed to fetch posted jobs");

                const jobs = await res.json();
                const container = document.getElementById("posted-jobs-list");

                if (jobs.length === 0) {
                  Swal.fire({
                    icon: "info",
                    title: "No Jobs Posted",
                    text: "You haven't posted any jobs yet.",
                    confirmButtonColor: "#ec7113",
                    background: "#fffaf0",
                    backdrop: "rgba(255, 215, 160, 0.3)",
                  });
                  return;
                }

                jobs.forEach((job) => {
                  const jobCard = document.createElement("div");
                  jobCard.className = "flex gap-4 bg-[#fcfaf8] px-4 py-3";

                  jobCard.innerHTML = `
        <div
          class="bg-center bg-no-repeat aspect-square bg-cover rounded-lg size-[70px]"
          style="background-image: url('https://cdn.usegalileo.ai/sdxl10/fallback-job-thumb.png');"
        ></div>
        <div class="flex flex-1 flex-col justify-center">
          <a href="myapplicants.html?jobId=${job._id}" class="text-[#111922] text-base font-medium leading-normal hover:underline">
            ${job.title}
          </a>
          <p class="text-[#93adc8] text-sm font-normal leading-normal">
            ${job.description || "No description"}
          </p>
          <p class="text-[#93adc8] text-sm font-normal leading-normal">
            ${job.status} • ${new Date(job.createdAt).toLocaleDateString()}
          </p>
        </div>
      `;
                  container.appendChild(jobCard);
                });

                Swal.fire({
                  icon: "success",
                  title: "Jobs Loaded",
                  text: `${jobs.length} job(s) retrieved successfully.`,
                  timer: 2000,
                  showConfirmButton: false,
                  background: "#ecfdf5",
                  backdrop: "rgba(34,197,94,0.15)",
                });

              } catch (err) {
                console.error("❌ Error fetching posted jobs:", err);
                Swal.fire({
                  icon: "error",
                  title: "Failed to Load Jobs",
                  text: "Something went wrong while fetching your jobs.",
                  confirmButtonColor: "#ef4444",
                  background: "#fef2f2",
                  backdrop: "rgba(239, 68, 68, 0.2)",
                });
              }
            }

          </script>
          <script>
            document.addEventListener("DOMContentLoaded", async () => {
              const craftsmanId = localStorage.getItem("craftsmanId");
              const profilePicDiv = document.getElementById("profile-pic");

              if (!craftsmanId || !profilePicDiv) return;

              // Try cached image first
              const cachedImage = localStorage.getItem("profileImage");
              if (cachedImage) {
                profilePicDiv.style.backgroundImage = `url('${cachedImage}')`;
              }

              try {
                const res = await fetch(`/api/profile/${craftsmanId}`);
                if (!res.ok) throw new Error("Failed fetching profile");

                const data = await res.json();
                const profileImage =
                  data.profileImage.trim() || "/uploads/default.png";

                profilePicDiv.style.backgroundImage = `url('${profileImage}')`;

                // Update cache
                localStorage.setItem("profileImage", profileImage);
              } catch (error) {
                console.error("❌ Error loading profile:", error);
                Swal.fire({
                  icon: "error",
                  title: "Profile Load Failed",
                  text: "Unable to load your profile. Please refresh or try again.",
                  confirmButtonColor: "#ef4444",
                  background: "#fef2f2",
                  backdrop: "rgba(239, 68, 68, 0.2)",
                });
              }
            });

            async function fetchUnratedCompletedJobs(userId) {
              try {
                const res = await fetch(`/api/jobs/posted/${userId}`);
                const jobs = await res.json();
                const unrated = jobs.filter(
                  job => job.status === "completed" && job.ratingStatus === "not-rated"
                );

                if (unrated.length === 0) return;

                const section = document.getElementById("pending-rating-section");
                const container = document.getElementById("pending-rating-jobs");

                section.classList.remove("hidden");

                container.innerHTML = unrated.map(job => `
  <div class="flex justify-between items-center border p-4 rounded-lg bg-white shadow">
    <div>
      <p class="text-[#1b150d] font-medium">${job.title}</p>
      <p class="text-sm text-[#9a784c]">Completed on ${new Date(job.autoCompletedAt).toLocaleDateString()}</p>
    </div>
   <button onclick="openRatingAlert('${job._id}', '${job.craftsmanId}')" class="bg-[#ec8e13] text-white px-4 py-1.5 rounded hover:bg-orange-600">
      Rate Now
    </button>
  </div>
`).join("");
              } catch (err) {
                console.error("❌ Error fetching unrated jobs:", err);
              }
            }


            async function openRatingAlert(jobId, craftsmanId) {
              const { value: rating } = await Swal.fire({
                title: 'Rate the Craftsman',
                input: 'range',
                inputAttributes: {
                  min: 1,
                  max: 5,
                  step: 1
                },
                inputValue: 3,
                confirmButtonText: 'Submit Rating',
                confirmButtonColor: '#22c55e',
                showCancelButton: true,
                cancelButtonColor: '#ef4444',
                background: '#fefce8',
                backdrop: 'rgba(253, 224, 71, 0.3)',
                preConfirm: (value) => {
                  if (!value || value < 1 || value > 5) {
                    Swal.showValidationMessage('Please select a valid rating between 1 and 5.');
                  }
                }
              });

              if (rating) {
                try {
                  const res = await fetch(`/api/jobs/rating/${jobId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating: parseInt(rating), craftsmanId })
                  });

                  if (!res.ok) throw new Error("Failed to submit rating");

                  Swal.fire({
                    icon: 'success',
                    title: 'Thank you!',
                    text: 'Your rating has been submitted.',
                    timer: 2000,
                    showConfirmButton: false,
                    background: '#ecfdf5',
                    backdrop: 'rgba(34,197,94,0.15)'
                  });

                  fetchPostedJobs(localStorage.getItem("craftsmanId"));

                } catch (err) {
                  console.error("❌ Error submitting rating:", err);
                  Swal.fire({
                    icon: 'error',
                    title: 'Failed',
                    text: 'Could not submit your rating. Please try again.',
                    confirmButtonColor: '#ef4444'
                  });
                }
              }
            }

          </script>
          <script>
            // for disapper proposals if client
            document.addEventListener("DOMContentLoaded", () => {
              const userRole = localStorage.getItem("userRole");
              const proposalsLink = document.getElementById("proposals-link");

              if (userRole === "client" && proposalsLink) {
                proposalsLink.style.display = "none";
              }
            });
          </script>
</body>

</html>