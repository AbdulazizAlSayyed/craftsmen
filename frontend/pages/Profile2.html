<html>

<head>
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
  <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
    href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Work+Sans%3Awght%40400%3B500%3B700%3B900" />

  <title>Galileo Design</title>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="../js/chat-dot.js"></script>
  <script src="../js/notifications-common.js"></script>

</head>

<body>
  <div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden"
    style="font-family: 'Work Sans', 'Noto Sans', sans-serif">
    <div class="layout-container flex h-full grow flex-col">
      <header
        class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#f3eee7] px-10 py-3">
        <div class="flex items-center gap-8">
          <div class="flex items-center gap-4 text-[#1b150d]">
            <div class="size-4">
              <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd"
                  d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z"
                  fill="currentColor"></path>
              </svg>
            </div>
            <h2 class="text-[#1b150d] text-lg font-bold leading-tight tracking-[-0.015em]">
              Craftsman
            </h2>
          </div>
          <div class="flex items-center gap-9">
            <a class="text-[#1b150d] text-sm font-medium leading-normal" href="dashboard.html">Dashboard</a>
            <a class="text-[#1b150d] text-sm font-medium leading-normal" href="job.html">Hire</a>
            <a class="text-[#1b150d] text-sm font-medium leading-normal" href="Apply.html">Apply</a>
            <a class="text-[#1b150d] text-sm font-medium leading-normal" href="myjob.html">My Jobs</a>
            <a class="text-[#1b150d] text-sm font-medium leading-normal" href="proposal.html"
              id="proposals-link">Proposals</a>
          </div>
        </div>
        <div class="flex flex-1 justify-end gap-8">
          <div class="flex gap-2">
            <a href="Notification.html" class="relative">
              <button
                class="relative flex items-center justify-center h-10 w-10 rounded-xl bg-[#f3eee7] text-[#1b150d]">
                <!-- Red Dot for Unread -->
                <span id="notif-dot"
                  class="absolute -top-0.5 -right-0.5 h-2 w-2 bg-red-500 rounded-full ring-2 ring-white hidden"></span>

                <!-- Bell Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor"
                  viewBox="0 0 256 256">
                  <path
                    d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z">
                  </path>
                </svg>
              </button>

            </a>
            <a href="chat.html" class="relative">
              <button
                class="relative h-10 w-10 rounded-xl bg-[#f3eee7] text-[#1b150d] flex items-center justify-center">
                <span id="chat-dot"
                  class="absolute -top-0.5 -right-0.5 h-2 w-2 bg-red-500 rounded-full ring-2 ring-white hidden"></span>

                <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor"
                  viewBox="0 0 256 256">
                  <path
                    d="M140,128a12,12,0,1,1-12-12A12,12,0,0,1,140,128ZM84,116a12,12,0,1,0,12,12A12,12,0,0,0,84,116Zm88,0a12,12,0,1,0,12,12A12,12,0,0,0,172,116Zm60,12A104,104,0,0,1,79.12,219.82L45.07,231.17a16,16,0,0,1-20.24-20.24l11.35-34.05A104,104,0,1,1,232,128Zm-16,0A88,88,0,1,0,51.81,172.06a8,8,0,0,1,.66,6.54L40,216,77.4,203.53a7.85,7.85,0,0,1,2.53-.42,8,8,0,0,1,4,1.08A88,88,0,0,0,216,128Z">
                  </path>
                </svg>
              </button>
            </a>

            <a href="Setting.html" class="bg-[#f3eee7] rounded-xl h-10 flex items-center px-2.5">
              ‚öôÔ∏è
            </a>
          </div>
          <a href="#" id="profile-link">
            <div id="profile-pic" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10"></div>
          </a>
        </div>
      </header>
      <div class="px-40 flex flex-1 justify-center py-5">
        <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
          <div class="flex p-4 @container">
            <div class="flex w-full flex-col gap-4 @[520px]:flex-row @[520px]:justify-between @[520px]:items-center">
              <div class="flex gap-4">
                <img id="craftsman-profile-pic" class="rounded-full min-h-32 w-32" src="default.png"
                  alt="Profile Image" />

                <div class="flex flex-col justify-center">
                  <p id="craftsman-name" class="text-[#181411] text-[22px] font-bold leading-tight tracking-[-0.015em]">
                    <!-- Name will be inserted here -->
                  </p>

                  <!-- Bio will be inserted here -->
                  </p>
                  <p id="craftsman-location" class="text-[#897361] text-sm font-normal leading-normal">
                    <!-- Location will be inserted here -->
                  </p>
                </div>
              </div>
              <div class="flex w-full max-w-[480px] gap-3 @[480px]:w-auto">
                <a href="chat.html">
                <button
                  class="hire-btn flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 px-4 bg-[#f4f2f0] text-[#181411] text-sm font-bold leading-normal tracking-[0.015em] flex-1 @[480px]:flex-auto">
                  <span class="truncate">Hire Me</span>
                </button>
              </a>
                <button
                  class="invite-btn flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 px-4 bg-[#ec7113] text-white text-sm font-bold leading-normal tracking-[0.015em] flex-1 @[480px]:flex-auto">
                  <span class="truncate">Invite to Job</span>
                </button>
              </div>
            </div>
          </div>

          <h2 class="text-[#181411] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">
            Abouts
          </h2>
          <p id="craftsman-bio" class="text-[#897361] text-base font-normal leading-normal">

          <h2 class="text-[#181411] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">
            Skills
          </h2>
          <div id="skills-tabs" class="flex gap-3 p-3 flex-wrap pr-4">
            <!-- Skills will load here dynamically -->
          </div>

         <div class="mt-3 p-4 bg-gray-100 rounded-xl shadow-sm text-sm space-y-1 max-w-md">
          <h3 id="skill-name" class="text-lg font-semibold text-gray-800 mb-2"></h3>
         <div class="flex justify-between"><span>üéñÔ∏è Rank:</span> <span id="skill-rank" class="text-gray-700"></span></div>
        <div class="flex justify-between"><span>üß† Experience:</span> <span id="skill-experience" class="text-gray-700"></span></div>
  <div class="flex justify-between"><span>‚≠ê Rating:</span> <span id="skill-rating" class="text-gray-700"></span></div>
 
  <div class="mt-2">
  <div class="w-full bg-gray-200 rounded-full h-2.5">
    <div id="xp-bar" class="bg-orange-500 h-2.5 rounded-full" style="width: 0%"></div>
  </div>
  <p id="xp-text" class="text-xs text-gray-600 mt-1"></p>
</div>

</div>

          <h2 class="text-[#181411] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">
            Experience
          </h2>
          <div id="job-list"></div>


        </div>
      </div>

    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const craftsmanId = urlParams.get("craftsmanId");
      let skillName = urlParams.get("skill") || "General"; // fallback if missing

      // Debugging logs
      console.log("üîç Extracted craftsmanId:", craftsmanId);
      console.log("üîç Extracted skillName:", skillName);

      if (!craftsmanId || !skillName) {
        Swal.fire({
          icon: 'error',
          title: 'Missing Info',
          text: 'Craftsman ID or skill is missing from the URL.',
        });
        return;
      }


      try {
        // ‚úÖ Fetch profile data
        const profileRes = await fetch(`/api/profile/${craftsmanId}`);
        if (!profileRes.ok) {
          Swal.fire({
            icon: 'error',
            title: 'Fetch Failed',
            text: 'Unable to load profile information.',
          });
        }

        const data = await profileRes.json();

        // ‚úÖ Update Profile Info
        document.getElementById("craftsman-name").textContent = data.fullName || "Unknown";
        document.getElementById("craftsman-bio").textContent = data.bio || "No bio available";
        document.getElementById("craftsman-location").textContent = data.location || "Location not provided";

        const profilePic = document.getElementById("craftsman-profile-pic");
        profilePic.src = data.profileImage?.trim() ? data.profileImage : "/uploads/default.png";

        // ‚úÖ Update Skill Section
        if (data.skills && data.skills.length > 0) {
          let skill = skillName === "General"
            ? data.skills[0]
            : data.skills.find(s => s.name === skillName);

          if (!skill) {
            skill = data.skills[0];
            console.warn(`‚ö†Ô∏è No skill matched '${skillName}', falling back to first skill.`);
          }
          else {
            document.getElementById("skill-name").textContent = skill.name;
document.getElementById("skill-rank").textContent = skill.rank;
document.getElementById("skill-experience").textContent = `${skill.xpPoints} XP`;
document.getElementById("skill-rating").textContent = `${skill.rating.toFixed(1)}‚≠ê (${skill.numberOfRatedJobs} rated jobs)`;
updateXPBar(skill.xpPoints);
          }
        } else {
          console.warn("‚ö†Ô∏è No skills found for this craftsman");
        }

        // ‚úÖ Fetch Completed Jobs Related to the Skill
        // ‚úÖ Fetch Completed Jobs Related to the Skill
        if (skillName !== "General") {
          try {
            const jobRes = await fetch(`/api/jobs/completed/${craftsmanId}/${encodeURIComponent(skillName)}`);

            if (!jobRes.ok) {
              Swal.fire({
                icon: 'error',
                title: 'Failed to Load Jobs',
                text: `Could not load jobs for skill: ${skillName}`,
              });
              return;
            }

            const completedJobs = await jobRes.json();
            const jobList = document.getElementById("job-list");
            jobList.innerHTML = "";

            if (completedJobs.length > 0) {
              completedJobs.forEach((job) => {
                const jobElement = document.createElement("div");
                jobElement.className = "p-3 border rounded-lg shadow bg-gray-100 mb-3";
                jobElement.innerHTML = `
          <h3 class="font-bold text-lg">${job.title}</h3>
          <p class="text-sm text-gray-600">${job.description || "No description available."}</p>
          <p class="text-sm text-gray-700">üí∞ Budget: $${job.budget}</p>
          <p class="text-sm text-gray-700">üìä Level: ${job.jobRank}</p>
          ${job.ratings > 0
                    ? `<p class="text-sm text-yellow-500">‚≠ê Rating: ${job.ratings.toFixed(1)} / 5</p>`
                    : `<p class="text-sm text-gray-500">‚≠ê No rating available</p>`}
        `;
                jobList.appendChild(jobElement);
              });
            } else {
              jobList.innerHTML = `
        <div class="p-4 bg-orange-50 border border-orange-300 rounded-lg shadow-sm text-center text-orange-700">
          <p class="font-medium">No completed jobs found for <strong>${skillName}</strong>.</p>
        </div>
      `;
            }
          } catch (error) {
            console.error("‚ùå Error fetching completed jobs:", error);
          }
        }


      }


      catch (error) {
        console.error("‚ùå Failed to fetch profile data:", error);
      }
    });
  </script>


  <script>
    async function loadSkills(userId) {
      try {
        const response = await fetch(`/api/profile/${userId}/all-skills`);
        if (!response.ok) throw new Error("Failed to fetch skills");

        const { skills } = await response.json();

        const skillsTabs = document.getElementById("skills-tabs");
        skillsTabs.innerHTML = "";

        skills.forEach((skill) => {
          const skillTab = document.createElement("button");
          skillTab.className = "p-2 bg-gray-200 rounded-md";
          skillTab.textContent = skill.name;
          skillTab.onclick = () => {
            window.location.href = `profile2.html?craftsmanId=${userId}&skill=${skill.name}`;
          };
          skillsTabs.appendChild(skillTab);
        });
      } catch (error) {
        console.error("‚ùå Failed to load skills:", error);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const userId = new URLSearchParams(window.location.search).get(
        "craftsmanId"
      );
      if (userId) {
        loadSkills(userId);
      }
    });
  </script>

  <script>
    // this for profile to go to main skill
    document.addEventListener("DOMContentLoaded", async () => {
      const userId = new URLSearchParams(window.location.search).get(
        "craftsmanId"
      );

      if (!userId) {
        console.error("‚ùå Missing craftsmanId in URL");
        return;
      }

      try {
        // Fetch user profile data
        const res = await fetch(`/api/profile/${userId}`);
        if (!res.ok) throw new Error("Failed to fetch profile");

        const data = await res.json();

        // Get main skill (first skill)
        let mainSkill = "General";
        if (Array.isArray(data.skills) && data.skills.length > 0 && data.skills[0].name) {
          mainSkill = data.skills[0].name;
        }
        //abd now
        // Set profile image (or default if unavailable)
        //const profilePicDiv = document.getElementById("profile-pic");
        //profilePicDiv.style.backgroundImage = `url(${
        //  data.profileImage || "/uploads/default.png"
        //})`;

        const profilePicDiv = document.getElementById("profile-pic");
        if (profilePicDiv) {
          profilePicDiv.style.backgroundImage = `url('${data.profileImage?.trim() || "/uploads/default.png"
            }')`;
        } else {
          console.error("‚ùå Element #profile-pic not found in the DOM");
        }

        // Make the image a clickable link to the profile page with main skill
        const profileLink = document.getElementById("profile-link");
        profileLink.href = `Profile2.html?craftsmanId=${userId}&skill=${encodeURIComponent(
          mainSkill
        )}`;
      } catch (err) {
        console.error("‚ùå Error loading profile:", err);
      }
    });
  </script>

  <script>
    // for disapper proposals if client
    document.addEventListener("DOMContentLoaded", () => {
      const userRole = localStorage.getItem("userRole");
      const proposalsLink = document.getElementById("proposals-link");

      if (userRole === "client" && proposalsLink) {
        proposalsLink.style.display = "none";
      }
    });
  </script>
  <!-- Invite to Job Modal -->
  <div id="invite-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-full max-w-md shadow-lg">
      <h2 class="text-lg font-bold mb-4">Invite to Job</h2>
      <label class="block mb-2 text-sm font-medium">Select Job</label>
      <select id="job-select" class="w-full p-2 border rounded mb-4">
        <option disabled selected>Loading your jobs...</option>
      </select>
      <div class="flex justify-end gap-2">
        <button id="cancel-invite" class="px-4 py-2 bg-gray-200 rounded">Cancel</button>
        <button id="send-invite" class="px-4 py-2 bg-orange-600 text-white rounded" disabled>Send Invite</button>

      </div>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const inviteBtn = document.querySelector(".invite-btn");
      const inviteModal = document.getElementById("invite-modal");
      const cancelInvite = document.getElementById("cancel-invite");
      const sendInvite = document.getElementById("send-invite");
      const jobSelect = document.getElementById("job-select");
      const craftsmanId = new URLSearchParams(location.search).get("craftsmanId");
      const userId = localStorage.getItem("userId"); // Get clientId from localStorage

      inviteBtn.addEventListener("click", async () => {
        inviteModal.classList.remove("hidden");

        // Load your posted jobs
        try {
          const res = await fetch(`/api/jobs/posted/${userId}`);
          const jobs = await res.json();
          jobSelect.innerHTML = "";
        jobs
  .filter(job => job.status === "open") // ‚úÖ just to be extra sure
  .forEach((job) => {
    const option = document.createElement("option");
    option.value = job._id;
    option.textContent = job.title;
    jobSelect.appendChild(option);
  });
        } catch (err) {
          console.error("‚ùå Failed to load jobs", err);
          jobSelect.innerHTML = `<option disabled>Unable to load jobs</option>`;
        }
      });

      cancelInvite.addEventListener("click", () => {
        inviteModal.classList.add("hidden");
      });
      jobSelect.addEventListener("change", () => {
  sendInvite.disabled = !jobSelect.value;
});

      sendInvite.addEventListener("click", async () => {
  const jobId = jobSelect.value;

  try {
    const res = await fetch("/api/invite", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ jobId, craftsmanId, clientId: userId }),
    });

    const result = await res.json();

    if (!res.ok) {
      if (res.status === 409) {
        Swal.fire({
          icon: 'info',
          title: 'Already Invited',
          text: 'You have already invited this craftsman to the selected job.',
        });
        return;
      }
      if (res.status === 403) {
        sendInvite.disabled = true;
  Swal.fire({
    icon: 'warning',
    title: 'Invite Blocked',
    text: 'A craftsman has already been accepted for this job.',
  });
  return;
}
      throw new Error(result.error || "Failed to send invite");
    }

    Swal.fire({
      icon: 'success',
      title: '‚úÖ Invite Sent',
      text: result.message,
    });
    inviteModal.classList.add("hidden");

  }catch (err) {
  if (err.message === "A craftsman has already been accepted for this job.") {
    Swal.fire({
      icon: "info",
      title: "Job Already Assigned",
      text: "You‚Äôve already accepted a craftsman for this job. You cannot invite another.",
      confirmButtonColor: "#ef4444"
    });
  } else if (err.message === "Invite already sent to this craftsman for this job.") {
    sendInvite.disabled = true;
    Swal.fire({
      icon: "warning",
      title: "Duplicate Invite",
      text: "This craftsman has already been invited for this job.",
      confirmButtonColor: "#ef4444"
    });
  } else {
    Swal.fire({
      icon: 'error',
      title: '‚ùå Failed',
      text: err.message,
      confirmButtonColor: "#ef4444"
    });
  }

  console.error("Invite error:", err);
}

});


    });

  </script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const viewerId = localStorage.getItem("userId"); // the logged-in user
    const profileId = new URLSearchParams(window.location.search).get("craftsmanId");

    if (viewerId === profileId) {
      // Hide "Hire Me" and "Invite to Job" buttons if user is viewing their own profile
      document.querySelector(".invite-btn")?.classList.add("hidden");
      document.querySelector('.hire-btn')?.classList.add("hidden");
    }
  });
  function updateXPBar(xp) {
  const xpBar = document.getElementById("xp-bar");
  const xpText = document.getElementById("xp-text");

  let maxXP = 100;
  if (xp > 100 && xp <= 300) maxXP = 300;
  else if (xp > 300 && xp <= 600) maxXP = 600;
  else if (xp > 600) maxXP = 1000;

  const percent = Math.min((xp / maxXP) * 100, 100);
  xpBar.style.width = `${percent}%`;
  xpText.textContent = `${xp} XP / ${maxXP}`;
}

</script>

</body>

</html>